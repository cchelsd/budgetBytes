<!DOCTYPE html>

<head>
  <title>Budget-Bytes</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.3.1/dist/css/bootstrap.min.css"
    integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <link rel="stylesheet" href="styles.css">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!--Google Maps API-->
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAruV7jgVj0gHwVIv66tazWCGyxOCTmtWc&callback=locationMap"
    async defer></script>
</head>



<header>
  <div id="webAppName">
    <a href="landingPage.html">
      <img src="images/logo.png" alt="Budget Bytes Logo" id="logo" />
      <img src="images/name.png" alt="Budget Bytes" id="name" />
    </a>
  </div>

  <nav class="navbar navbar-expand-lg navbar-light bg-white">
    <div class="collapse navbar-collapse" id="navbarNavAltMarkup">
      <div class="navbar-nav">
        <a class="nav-item nav-link" href="landingPage.html">Home</a> <!-- landing page -->
        <a class="nav-item nav-link" href="chatPage.html">Chat with Budget Bytes</a>
        <!-- <span class="sr-only">(current)</span>-->
        <a class="nav-item nav-link active" href="locateStores.html">Locate Stores</a>
        <a class="nav-item nav-link" href="mealPlan.html">Meal Plan</a>
        <a class="nav-item nav-link" href="wordCount.html">Word Search</a>
        <a class="nav-item nav-link" href="cookingAssessment.html">Cooking Assessment</a>
        <a class="nav-item nav-link" href="aboutPage.html">About</a>
      </div>
    </div>
  </nav>

</header>

<body>


  <div class="background">
    <div class="address-container">
      <div class="address-title">
        <p>Find Nearby Stores</p>
      </div>
      <form id="address-form">
        <div class="address">
          <input type="text" id="address-input"
            placeholder="Address_Input_Example: 123 Main St, City, State_OR_City,Country">
          <button>Search</button>
        </div>
      </form>
      <div id="map"></div>

    </div>
  </div>
  <footer class="py-3 my-2">
    <ul class="nav justify-content-center border-bottom pb-3 mb-3">
      <li class="nav-item"><a href="landingPage.html" class="nav-link px-2 text-muted">Home</a></li>
      <li class="nav-item"><a href="chatPage.html" class="nav-link px-2 text-muted">Chat with Budget
          Bytes</a></li>
      <li class="nav-item active"><a href="locateStores.html" class="nav-link px-2 text-muted">Locate Stores</a></li>
      <li class="nav-item"><a href="mealPlan.html" class="nav-link px-2 text-muted">Meal Plan</a></li>
      <li class="nav-item"><a href="wordCount.html" class="nav-link px-2 text-muted">Word Search</a>
      </li>
      <li class="nav-item"><a href="cookingAssessment.html" class="nav-link px-2 text-muted">Cooking
          Assessment</a></li>
      <li class="nav-item"><a href="aboutPage.html" class="nav-link px-2 text-muted">About</a></li>
    </ul>
    <p class="text-center text-muted">Â© 2023 Budget Bytes</p>
  </footer>

  <script>

    // OpenCage Geocoding API key
    const OPENCAGE_GEOCODING_API_KEY = `0ade0ea9cd23417480b5240558db5f48`;

    // Geoapify API key
    const GEOAPIFY_API_KEY = `42d8ca6fe1d34c1ba2f69cac1818942e`;


    // Function to handle the address form submission
    document.getElementById('address-form').addEventListener('submit', function (e) {
      e.preventDefault(); // Prevent the form from submitting and refreshing the page

      // Get the user-entered address from the input field
      const address = document.getElementById('address-input').value;

      if (address.trim() === '') {
        // Address field is empty, show an error message
        alert('Please enter a valid address.');
      } else {
        // Use the entered address to fetch latitude and longitude
        getLatLongFromAddress(address);
      }
    });


    // Function to fetch latitude and longitude based on the entered address
    async function getLatLongFromAddress(address) {
      // Check if the cached data is available
      const cachedData = localStorage.getItem('addressData-' + address);

      if (cachedData) {
        // If cached data exists, parse it
        const cached = JSON.parse(cachedData);

        // Use the cached latitude and longitude
        const latitude = cached.latitude;
        const longitude = cached.longitude;
        console.log("Using cached lat and lng.");

        locationMap(latitude, longitude);
      } else {
        try {
          const response = await fetch(`https://api.opencagedata.com/geocode/v1/json?q=${encodeURIComponent(address)}&key=${OPENCAGE_GEOCODING_API_KEY}`);
          const data = await response.json();

          if (data.results && data.results.length > 0) {
            const result = data.results[0];

            // Extract latitude and longitude from the result
            const latitude = result.geometry.lat;
            const longitude = result.geometry.lng;

            locationMap(latitude, longitude);

            // Cache the latitude and longitude data
            const cachedData = {
              latitude: latitude,
              longitude: longitude
            };
            localStorage.setItem('addressData-' + address, JSON.stringify(cachedData));
            console.log("Cached the lat and lng.");

          } else {
            console.log("No results found for the entered address.");
          }
        } catch (error) {
          console.error('Error fetching data:', error);
        }
      }
    }

    // Function to fetch Google Map data and nearby stores using latitude and longitude
    function locationMap(latitude, longitude) {
      console.log("Your Latitude: " + latitude + ", Longitude: " + longitude);
      const map = new google.maps.Map(document.getElementById('map'), {
        center: { lat: parseFloat(latitude), lng: parseFloat(longitude) },
        zoom: 13,
      });

      // Create a marker for Your current location
      const marker = new google.maps.Marker({
        map: map,
        position: { lat: parseFloat(latitude), lng: parseFloat(longitude) },
        title: "Your Current Location",
      });

      // Geoapify API request to get nearby supermarkets
      fetch(`https://api.geoapify.com/v2/places?categories=commercial.supermarket&filter=circle:${longitude},${latitude},5000&bias=proximity:${longitude},${latitude}&limit=20&apiKey=${GEOAPIFY_API_KEY}`)
        .then(response => response.json())
        .then(result => {
          // Iterate over features and create markers for each place
          result.features.forEach(place => {
            // Construct the marker title using name and address information
            const markerTitle = `${place.properties.name}<br>${place.properties.address_line2}`;

            // Create a marker for each place
            const placeMarker = new google.maps.Marker({
              map: map,
              position: { lat: place.geometry.coordinates[1], lng: place.geometry.coordinates[0] },
              title: markerTitle,
            });

            // Create an InfoWindow with additional information
            const infoWindow = new google.maps.InfoWindow({
              content: markerTitle,
            });

            // Add a click event listener to the marker
            placeMarker.addListener('click', () => {
              // Zoom into the area and open the InfoWindow
              map.setCenter(placeMarker.getPosition());
              map.setZoom(17); // Adjust the zoom level
              infoWindow.open(map, placeMarker);
            });

          });
        })
        .catch(error => console.log('Error:', error));
    }

  </script>
</body>

</html>